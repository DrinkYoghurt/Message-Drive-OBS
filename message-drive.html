<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>OBS Message Drive</title>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
  <script crossorigin src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.5/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      margin: 0;
      padding: 0;
      overflow: hidden;
      font-family: 'Courier New', monospace;
    }

    /* text selection */
    * {
      user-select: none;
      -webkit-user-select: none;
      -ms-user-select: none;
    }

    /* Custom scrollbar */
    .custom-scrollbar {
      scroll-behavior: smooth;
      scrollbar-width: none;
      -ms-overflow-style: none;
      -webkit-overflow-scrolling: touch;
    }
    
    .custom-scrollbar::-webkit-scrollbar {
      display: none;
    }

    @keyframes scanline {
      0% { transform: translateY(-100%); }
      100% { transform: translateY(100%); }
    }

    @keyframes glitch {
      0%, 100% { transform: translate(0); }
      33% { transform: translate(-2px, 2px); }
      66% { transform: translate(2px, -2px); }
    }

    @keyframes eject {
      0% { transform: translateX(0) scale(0.8); opacity: 0; }
      50% { transform: translateX(150px) scale(1); opacity: 1; }
      100% { transform: translateX(300px) scale(1); opacity: 1; }
    }

    @keyframes matrix-rain {
      0% { transform: translateY(0); opacity: 0; }
      10% { opacity: 0.15; }
      90% { opacity: 0.15; }
      100% { transform: translateY(100vh); opacity: 0; }
    }

    .scanline {
      animation: scanline 8s linear infinite;
    }

    .glitch-text {
      animation: glitch 0.3s infinite;
    }

    .eject-animation {
      animation: eject 0.6s ease-out forwards;
    }

    .matrix-char {
      animation: matrix-rain linear infinite;
      color: #00ff00;
      text-shadow: 0 0 3px #00ff00;
      font-family: 'Courier New', monospace;
      font-weight: bold;
      position: absolute;
      opacity: 0.15;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    function MatrixRain({ containerRef }) {
      const [chars, setChars] = useState([]);

      useEffect(() => {
        if (!containerRef.current) return;

        const container = containerRef.current;
        const width = container.offsetWidth;
        const columns = Math.floor(width / 15);
        const matrixChars = 'ABCDEF0123456789';

        const generateChars = () => {
          const newChars = [];
          for (let i = 0; i < columns; i++) {
            if (Math.random() > 0.9) {
              const numChars = Math.floor(Math.random() * 5) + 3;
              for (let j = 0; j < numChars; j++) {
                newChars.push({
                  id: Math.random(),
                  char: matrixChars[Math.floor(Math.random() * matrixChars.length)],
                  left: i * 15,
                  top: -(j * 20),
                  duration: Math.random() * 2 + 3,
                  delay: Math.random() * 1
                });
              }
            }
          }
          return newChars;
        };

        setChars(generateChars());
        const interval = setInterval(() => {
          setChars(prev => [...prev, ...generateChars()]);
        }, 200);
        const cleanup = setInterval(() => {
          setChars(prev => prev.filter(c => Math.random() > 0.3));
        }, 1000);

        return () => {
          clearInterval(interval);
          clearInterval(cleanup);
        };
      }, [containerRef]);

      return (
        <div className="absolute inset-0 overflow-hidden pointer-events-none">
          {chars.map(item => (
            <span
              key={item.id}
              className="matrix-char text-sm"
              style={{
                left: `${item.left}px`,
                top: `${item.top}px`,
                animationDuration: `${item.duration}s`,
                animationDelay: `${item.delay}s`
              }}
            >
              {item.char}
            </span>
          ))}
        </div>
      );
    }

    function MessageDrive() {
      const [messages, setMessages] = useState([]);
      const [availableMessages, setAvailableMessages] = useState([]);
      const [currentMessage, setCurrentMessage] = useState(null);
      const [ejecting, setEjecting] = useState(false);
      const [loading, setLoading] = useState(true);
      const [error, setError] = useState(null);
      
      const [drivePosition, setDrivePosition] = useState(() => {
        try {
          const saved = localStorage.getItem('drivePosition');
          if (saved) return JSON.parse(saved);
        } catch (e) {}
        return { x: 32, y: window.innerHeight - 400 };
      });
      
      const [isDragging, setIsDragging] = useState(false);
      const [dragOffset, setDragOffset] = useState({ x: 0, y: 0 });
      
      const [isLocked, setIsLocked] = useState(() => {
        try {
          const saved = localStorage.getItem('isLocked');
          if (saved === 'false') return false;
          return true; // Default to locked
        } catch (e) {
          return true;
        }
      });

      const driveRef = useRef(null);
      const modalRef = useRef(null);

      useEffect(() => { loadMessages(); }, []);

      useEffect(() => {
        const handleMouseMove = (e) => {
          if (isDragging) {
            const newPosition = {
              x: e.clientX - dragOffset.x,
              y: e.clientY - dragOffset.y
            };
            setDrivePosition(newPosition);
          }
        };
        const handleMouseUp = () => setIsDragging(false);

        if (isDragging) {
          document.addEventListener('mousemove', handleMouseMove);
          document.addEventListener('mouseup', handleMouseUp);
        }

        return () => {
          document.removeEventListener('mousemove', handleMouseMove);
          document.removeEventListener('mouseup', handleMouseUp);
        };
      }, [isDragging, dragOffset]);

      useEffect(() => {
        try {
          localStorage.setItem('drivePosition', JSON.stringify(drivePosition));
        } catch (e) {
          console.error('Failed to save position:', e);
        }
      }, [drivePosition]);

      useEffect(() => {
        try {
          localStorage.setItem('isLocked', JSON.stringify(isLocked));
        } catch (e) {
          console.error('Failed to save lock state:', e);
        }
      }, [isLocked]);

      // Only save messages after they've been loaded (not on initialization)
      useEffect(() => {
        if (messages.length > 0 && !loading) {
          try {
            localStorage.setItem('messages', JSON.stringify(messages));
            localStorage.setItem('availableMessages', JSON.stringify(availableMessages));
            console.log('Saved messages state:', availableMessages.length, 'remaining of', messages.length);
          } catch (e) {
            console.log('Could not save to localStorage (this is normal in OBS)');
          }
        }
      }, [availableMessages, loading]);

      const handleMouseDown = (e) => {
        if (e.target.closest('button') || isLocked) return;
        const rect = e.currentTarget.getBoundingClientRect();
        setDragOffset({ x: e.clientX - rect.left, y: e.clientY - rect.top });
        setIsDragging(true);
      };

      const toggleLock = () => setIsLocked(!isLocked);

      const loadMessages = async () => {
        try {
          console.log('Attempting to load active_messages.json...');
          const response = await fetch('active_messages.json');
          
          if (!response.ok) {
            throw new Error('Could not load active_messages.json');
          }
          
          const data = await response.json();
          console.log('Loaded data:', data);
          
          const loadedMessages = data.messages || data;
          console.log('Parsed messages:', loadedMessages.length, 'messages');

          if (!loadedMessages || loadedMessages.length === 0) {
            throw new Error('No messages found in file');
          }

          // Try to restore saved progress
          try {
            const savedMessages = localStorage.getItem('messages');
            const savedAvailable = localStorage.getItem('availableMessages');
            
            if (savedMessages && savedAvailable) {
              const parsedMessages = JSON.parse(savedMessages);
              const parsedAvailable = JSON.parse(savedAvailable);
              
              // Verify saved data matches current file
              if (parsedMessages.length === loadedMessages.length) {
                console.log('✓ Restored saved progress:', parsedAvailable.length, 'remaining of', parsedMessages.length);
                setMessages(parsedMessages);
                setAvailableMessages(parsedAvailable);
                setLoading(false);
                return;
              } else {
                console.log('File changed, loading fresh messages');
              }
            }
          } catch (e) {
            console.log('No saved progress found, loading fresh');
          }

          // Load fresh messages
          setMessages(loadedMessages);
          setAvailableMessages([...loadedMessages]);
          
          setLoading(false);
          console.log('✓ Messages loaded successfully! Total:', loadedMessages.length);
          
        } catch (err) {
          console.error('Error loading messages:', err);
          setError(err.message);

          const fallbackMessages = [
            { id: 1, text: "SYSTEM.MSG: You're awesome!", author: 'User_001' },
            { id: 2, text: "DATA.LOG: Keep up the great work!", author: 'User_002' },
            { id: 3, text: "INFO.TXT: Thanks for streaming!", author: 'User_003' },
            { id: 4, text: "NOTE.DAT: Love your content!", author: 'User_004' },
            { id: 5, text: "MSG.SYS: You make my day!", author: 'User_005' }
          ];

          setMessages(fallbackMessages);
          setAvailableMessages([...fallbackMessages]);
          setLoading(false);
        }
      };

      const ejectMessage = () => {
        if (availableMessages.length === 0 || ejecting) {
          if (availableMessages.length === 0 && messages.length > 0) {
            setAvailableMessages([...messages]);
          }
          return;
        }

        setEjecting(true);
        const randomIndex = Math.floor(Math.random() * availableMessages.length);
        const selected = availableMessages[randomIndex];
        const newAvailable = availableMessages.filter((_, i) => i !== randomIndex);
        setAvailableMessages(newAvailable);

        setTimeout(() => setCurrentMessage(selected), 300);
        setTimeout(() => setEjecting(false), 600);
      };

      const closeMessage = () => setCurrentMessage(null);

      if (loading) {
        return (
          <div className="w-full h-screen bg-transparent flex items-center justify-center">
            <div className="text-2xl font-bold text-green-500 animate-pulse">
              [LOADING DATA...]
            </div>
          </div>
        );
      }

      return (
        <div className="w-full h-screen bg-transparent relative">
          {/* Draggable Drive */}
          <div
            className="absolute"
            style={{
              left: `${drivePosition.x}px`,
              top: `${drivePosition.y}px`,
              cursor: isLocked ? 'default' : (isDragging ? 'grabbing' : 'grab')
            }}
          >
            <div className="relative" onMouseDown={handleMouseDown}>
              <div
                ref={driveRef}
                className="relative w-80 h-72 bg-gradient-to-br from-gray-900 via-black to-gray-800 rounded-lg border-2 border-green-500 shadow-2xl overflow-hidden"
                style={{ boxShadow: '0 0 20px rgba(0,255,0,0.3), inset 0 0 20px rgba(0,255,0,0.1)' }}
              >
                <MatrixRain containerRef={driveRef} />
                <div className="absolute inset-0 pointer-events-none">
                  <div className="scanline w-full h-8 bg-gradient-to-b from-transparent via-green-500/20 to-transparent"></div>
                </div>
                <div className="absolute top-0 left-0 w-8 h-8 border-l-2 border-t-2 border-green-400 z-10"></div>
                <div className="absolute top-0 right-0 w-8 h-8 border-r-2 border-t-2 border-green-400 z-10"></div>
                <div className="absolute bottom-0 left-0 w-8 h-8 border-l-2 border-b-2 border-green-400 z-10"></div>
                <div className="absolute bottom-0 right-0 w-8 h-8 border-r-2 border-b-2 border-green-400 z-10"></div>

                <div className="absolute top-4 left-4 right-4 z-10">
                  <div className="bg-black/80 border border-green-500 px-3 py-2 rounded">
                    <div className="text-green-400 text-xs font-mono tracking-wider">
                      ╔═══════════════════════════════╗
                    </div>
                    <div className="text-green-400 text-base font-bold text-center">
                      MESSAGE.DRIVE
                    </div>
                    <div className="text-green-400 text-xs font-mono tracking-wider">
                      ╚═══════════════════════════════╝
                    </div>
                  </div>
                </div>

                <div className="absolute top-28 left-4 right-4 z-10">
                  <div className="bg-black/60 border border-green-500/50 px-4 py-4 rounded font-mono text-base">
                    <div className="text-green-400 mb-2">
                      <span className="text-green-300">STATUS:</span> ONLINE
                    </div>
                    <div className="text-green-400 mb-2">
                      <span className="text-green-300">FILES:</span> {availableMessages.length}/{messages.length} MSG
                    </div>
                    <div className="text-green-400 mb-2">
                      <span className="text-green-300">SPACE:</span> {(messages.length * 0.5).toFixed(1)}KB
                    </div>
                  </div>
                </div>

                <div className="absolute bottom-10 left-4 right-4 h-12 bg-black border-2 border-green-500/70 rounded overflow-hidden z-10">
                  <div className="absolute inset-0 flex items-center justify-center">
                    {ejecting ? (
                      <div className="eject-animation absolute left-2 bg-gradient-to-r from-green-400 to-green-600 text-black px-4 py-2 rounded text-xs font-bold"
                        style={{ boxShadow: '0 0 15px rgba(0,255,0,0.8)' }}>
                        EJECTING...
                      </div>
                    ) : (
                      <div className="text-green-500/50 text-xs font-mono">
                        [INSERT_SLOT]
                      </div>
                    )}
                  </div>
                  <div className="absolute inset-x-0 top-0 h-px bg-gradient-to-r from-transparent via-green-500 to-transparent"></div>
                  <div className="absolute inset-x-0 bottom-0 h-px bg-gradient-to-r from-transparent via-green-500 to-transparent"></div>
                </div>

                <button
                  onClick={toggleLock}
                  className="absolute top-6 right-6 hover:opacity-80 transition-all z-20 p-1"
                  style={{
                    filter: isLocked
                      ? 'drop-shadow(0 0 4px rgba(0,255,0,0.8))'
                      : 'drop-shadow(0 0 2px rgba(0,255,0,0.4))'
                  }}
                  title={isLocked ? 'Locked - Click to unlock' : 'Unlocked - Click to lock'}
                >
                  {isLocked ? (
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                      <rect x="3" y="7" width="10" height="7" stroke="#00ff00" strokeWidth="1.5" rx="1"/>
                      <path d="M5 7V5C5 3.343 6.343 2 8 2s3 1.343 3 3v2" stroke="#00ff00" strokeWidth="1.5" strokeLinecap="round"/>
                      <circle cx="8" cy="10.5" r="1" fill="#00ff00"/>
                    </svg>
                  ) : (
                    <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                      <rect x="3" y="7" width="10" height="7" stroke="#00ff00" strokeWidth="1.5" rx="1"/>
                      <path d="M5 7V5C5 3.343 6.343 2 8 2s3 1.343 3 3v1" stroke="#00ff00" strokeWidth="1.5" strokeLinecap="round"/>
                      <line x1="11" y1="3" x2="14" y2="6" stroke="#00ff00" strokeWidth="1.5" strokeLinecap="round"/>
                      <circle cx="8" cy="10.5" r="1" fill="#00ff00"/>
                    </svg>
                  )}
                </button>
              </div>

              <button
                onClick={ejectMessage}
                disabled={messages.length === 0 || ejecting}
                className="mt-4 w-full bg-gradient-to-r from-green-600 to-green-500 hover:from-green-500 hover:to-green-400 disabled:from-gray-600 disabled:to-gray-500 text-black font-bold py-3 px-6 rounded border-2 border-green-400 transition-all hover:scale-105 active:scale-95 disabled:cursor-not-allowed font-mono"
                style={{ boxShadow: '0 0 15px rgba(0,255,0,0.5)' }}
              >
                {ejecting ? '[PROCESSING...]' : availableMessages.length === 0 ? '↻ RESET & EJECT' : '▶ EJECT MESSAGE'}
              </button>
            </div>
          </div>

          {currentMessage && (
            <div className="fixed inset-0 flex items-center justify-center z-50 p-4 overflow-y-auto custom-scrollbar pointer-events-auto">
              <div
                ref={modalRef}
                className="border-4 border-green-500 p-8 w-full max-w-2xl max-h-[90vh] my-auto relative pointer-events-auto overflow-visible"
                style={{
                  background: 'rgba(0,0,0,0.98)',
                  boxShadow: '0 0 30px rgba(0,255,0,0.5), inset 0 0 30px rgba(0,255,0,0.1)'
                }}
              >
                <MatrixRain containerRef={modalRef} />
                <div className="absolute top-2 left-2 text-green-400 text-2xl font-bold leading-none pointer-events-none z-10">┏</div>
                <div className="absolute top-2 right-2 text-green-400 text-2xl font-bold leading-none pointer-events-none z-10">┓</div>
                <div className="absolute bottom-2 left-2 text-green-400 text-2xl font-bold leading-none pointer-events-none z-10">┗</div>
                <div className="absolute bottom-2 right-2 text-green-400 text-2xl font-bold leading-none pointer-events-none z-10">┛</div>
                <div className="absolute inset-0 pointer-events-none overflow-hidden">
                  <div className="scanline w-full h-12 bg-gradient-to-b from-transparent via-green-500/10 to-transparent"></div>
                </div>
                <div className="border-b-2 border-green-500/50 pb-3 mb-4 relative z-10">
                  <div className="text-green-400 text-xs font-mono mb-1">
                    ╔═══════════════════════════════════════╗
                  </div>
                  <div className="text-green-500 text-sm font-mono tracking-wider">
                    &gt;&gt; DATA RETRIEVED
                  </div>
                </div>
                <div className="bg-black/40 border border-green-500/30 p-6 rounded mb-4 relative z-10">
                  <p className="text-green-400 text-xl font-mono leading-relaxed mb-4 whitespace-pre-line">
                    {currentMessage.text}
                  </p>
                  {currentMessage.author && (
                    <p className="text-green-500/70 text-sm font-mono text-right">
                      — FROM: {currentMessage.author}
                    </p>
                  )}
                </div>
                <div className="border-t-2 border-green-500/50 pt-3 relative z-10">
                  <div className="text-green-400 text-xs font-mono mb-2">
                    ╚═══════════════════════════════════════╝
                  </div>
                  <button
                    onClick={closeMessage}
                    className="w-full bg-green-600 hover:bg-green-500 text-black font-bold py-2 px-4 rounded border-2 border-green-400 transition-all font-mono"
                    style={{ boxShadow: '0 0 10px rgba(0,255,0,0.5)' }}
                  >
                    [CLOSE] — PRESS ESC
                  </button>
                </div>
              </div>
            </div>
          )}

          {error && (
            <div className="fixed top-4 right-4 bg-black border-2 border-yellow-500 text-yellow-400 p-3 rounded max-w-xs text-sm font-mono"
              style={{ boxShadow: '0 0 15px rgba(255,255,0,0.3)' }}>
              <p className="font-bold">⚠ FALLBACK MODE</p>
              <p className="text-xs mt-1">Using sample data</p>
            </div>
          )}
        </div>
      );
    }

    ReactDOM.render(<MessageDrive />, document.getElementById('root'));
  </script>
</body>
</html>
